<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure Monitor Cost Optimizer</title>
    <link rel="stylesheet" href="styles.css?v=20260210">
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-top">
                <div class="logo">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="48" height="48">
                        <path fill="#0078d4" d="M24 4C12.954 4 4 12.954 4 24s8.954 20 20 20 20-8.954 20-20S35.046 4 24 4z"/>
                        <path fill="#fff" d="M24 8c-8.837 0-16 7.163-16 16s7.163 16 16 16 16-7.163 16-16S32.837 8 24 8zm0 28c-6.627 0-12-5.373-12-12s5.373-12 12-12 12 5.373 12 12-5.373 12-12 12z"/>
                        <path fill="#50e6ff" d="M24 14v10l7 7"/>
                    </svg>
                    <h1>Azure Monitor Cost Optimizer</h1>
                </div>
                <div class="auth-section">
                    <div class="theme-toggle">
                        <span class="theme-icon">‚òÄÔ∏è</span>
                        <div class="theme-toggle-btn" id="themeToggle">
                            <div class="theme-toggle-slider"></div>
                        </div>
                        <span class="theme-icon">üåô</span>
                    </div>
                    <div class="auth-status" id="authStatus">
                        <span class="status-indicator disconnected" id="statusIndicator">‚óè</span>
                        <span id="statusText">Not signed in</span>
                        <button id="signOutBtn" class="auth-btn-small" onclick="signOut()" hidden>Sign Out</button>
                    </div>
                </div>
            </div>
            <p class="subtitle">Get AI-powered recommendations based on your actual Azure Monitor usage</p>
        </header>

        <main>
            <!-- Auth Required Message -->
            <section class="auth-required-section" id="authRequiredSection">
                <div class="auth-required-content">
                    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#0078d4" stroke-width="1.5">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 16v-4"/>
                        <path d="M12 8h.01"/>
                    </svg>
                    <h2>Sign in to get started</h2>
                    <p>Run this command in your terminal to get an access token (automatically copies to clipboard):</p>
                    <div class="cli-command-container">
                        <code class="cli-command">az account get-access-token --resource https://management.azure.com --query accessToken -o tsv | pbcopy</code>
                        <button class="copy-cli-btn" onclick="copyCommand()">üìã Copy</button>
                    </div>
                    <p class="platform-note" style="font-size: 0.8em; color: #666; margin-top: 4px;">
                        <strong>Windows:</strong> Replace <code>pbcopy</code> with <code>clip</code> &nbsp;|&nbsp; 
                        <strong>Linux:</strong> Use <code>xclip -selection clipboard</code>
                    </p>
                    <p class="auth-step">Then paste the token here (Cmd+V / Ctrl+V):</p>
                    <textarea id="tokenInput" class="token-input" placeholder="Paste your access token here..." rows="3"></textarea>
                    <button id="signInBtn" class="primary-btn" onclick="signInWithToken()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
                            <polyline points="10 17 15 12 10 7"></polyline>
                            <line x1="15" y1="12" x2="3" y2="12"></line>
                        </svg>
                        Sign In with Token
                    </button>
                    <p class="auth-note">üîí Your token stays in your browser and is only sent to Azure APIs.</p>
                </div>
            </section>

            <!-- Main Input Section -->
            <section class="input-section" id="inputSection" hidden>
                <h2>Select Your Workspace</h2>
                
                <!-- Recent Analyses -->
                <div id="recentAnalyses" class="recent-analyses" hidden>
                    <h3>üìã Recent Analyses</h3>
                    <div id="recentAnalysesList" class="recent-analyses-list"></div>
                </div>
                
                <form id="azureForm" onsubmit="runAnalysis(); return false;">
                    <div class="form-group">
                        <label for="subscriptionFilter">Subscription</label>
                        <input type="text" id="subscriptionFilter" class="filter-input" placeholder="Type to filter subscriptions..." autocomplete="off" oninput="filterSubscriptions(this.value)">
                        <select id="subscriptionSelect" name="subscriptionSelect" onchange="loadWorkspaces(this.value)">
                            <option value="">Loading subscriptions...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Log Analytics Workspaces</label>
                        <div class="workspace-controls">
                            <input type="text" id="workspaceFilter" class="filter-input-small" placeholder="Filter workspaces..." oninput="filterWorkspaces(this.value)">
                            <button type="button" id="selectAllBtn" class="select-btn" onclick="selectAllWorkspaces()">All</button>
                            <button type="button" id="selectNoneBtn" class="select-btn" onclick="deselectAllWorkspaces()">None</button>
                            <button type="button" id="expandAllBtn" class="select-btn" onclick="expandAllGroups()">Expand</button>
                            <button type="button" id="collapseAllBtn" class="select-btn" onclick="collapseAllGroups()">Collapse</button>
                            <span id="selectedCount" class="selected-count">0 selected</span>
                        </div>
                        <div id="workspaceList" class="workspace-list">
                            <div class="workspace-placeholder">Select a subscription first</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="context">Additional Context <span class="optional">(optional)</span></label>
                        <textarea id="context" name="context" rows="3" 
                                  placeholder="Any specific concerns or areas you'd like us to focus on..."></textarea>
                    </div>

                    <!-- Azure OpenAI Settings -->
                    <details class="ai-settings" id="aiSettings">
                        <summary>ü§ñ AI Settings (for enhanced recommendations)</summary>
                        <div class="ai-settings-content">
                            <p>Provide your Azure OpenAI details for AI-powered recommendations. Without these, you'll get rule-based analysis.</p>
                            
                            <div class="ai-help-section" style="background: #f0f7ff; border-left: 4px solid #0078d4; padding: 12px; margin-bottom: 16px; border-radius: 0 8px 8px 0; font-size: 0.9em;">
                                <strong>üìò How to get these from Azure AI Foundry:</strong>
                                <ol style="margin: 8px 0 0 0; padding-left: 20px; line-height: 1.6;">
                                    <li>Go to <a href="https://ai.azure.com" target="_blank" style="color: #0078d4;">ai.azure.com</a> and sign in</li>
                                    <li>Select your project (or create one)</li>
                                    <li>Go to <strong>Deployments</strong> in the left menu</li>
                                    <li>Deploy a model (e.g., gpt-4, gpt-4o) if you haven't already</li>
                                    <li>Click on your deployment ‚Üí Copy the <strong>Target URI</strong> (this is your Endpoint)</li>
                                    <li>Go to <strong>Project settings</strong> ‚Üí <strong>Keys and Endpoints</strong></li>
                                    <li>Copy <strong>Key 1</strong> (this is your API Key)</li>
                                    <li>The <strong>Deployment Name</strong> is the name you gave your deployment (e.g., "gpt-4")</li>
                                </ol>
                            </div>

                            <div class="form-group">
                                <label for="openaiEndpoint">Azure OpenAI Endpoint</label>
                                <input type="text" id="openaiEndpoint" placeholder="https://your-resource.openai.azure.com">
                                <small style="color: #666; font-size: 0.8em;">Target URI from AI Foundry deployment</small>
                            </div>
                            <div class="form-group">
                                <label for="openaiKey">API Key</label>
                                <input type="password" id="openaiKey" placeholder="Your Azure OpenAI API key">
                                <small style="color: #666; font-size: 0.8em;">Key 1 from Project settings ‚Üí Keys and Endpoints</small>
                            </div>
                            <div class="form-group">
                                <label for="openaiDeployment">Deployment Name</label>
                                <input type="text" id="openaiDeployment" placeholder="gpt-4" value="gpt-4">
                                <small style="color: #666; font-size: 0.8em;">Name of your deployed model (e.g., gpt-4, gpt-4o)</small>
                            </div>
                            <button type="button" class="save-settings-btn" onclick="saveAISettings()">üíæ Save Settings</button>
                        </div>
                    </details>

                    <button type="submit" id="submitBtn" disabled>
                        <span class="btn-text">Analyze & Get Recommendations</span>
                        <span class="btn-loader" style="display: none;">
                            <svg class="spinner" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" stroke-dasharray="31.416" stroke-dashoffset="10"/>
                            </svg>
                            <span id="loadingStatus">Querying workspace...</span>
                        </span>
                    </button>
                </form>
            </section>

            <!-- Analysis Progress Section -->
            <section class="progress-section" id="progressSection" hidden>
                <h2>Analyzing Your Environment</h2>
                <div class="progress-content">
                    <div class="progress-item" id="progressAuth">
                        <span class="progress-icon">‚è≥</span>
                        <span class="progress-text">Authenticating...</span>
                    </div>
                    <div class="progress-item" id="progressQueries">
                        <span class="progress-icon">‚è≥</span>
                        <span class="progress-text">Running analysis queries...</span>
                    </div>
                    <div class="progress-item" id="progressAdvisor">
                        <span class="progress-icon">‚è≥</span>
                        <span class="progress-text">Fetching Azure Advisor recommendations...</span>
                    </div>
                    <div class="progress-item" id="progressAI">
                        <span class="progress-icon">‚è≥</span>
                        <span class="progress-text">Generating AI recommendations...</span>
                    </div>
                </div>
            </section>

            <section class="recommendations-section" id="recommendationsSection" hidden>
                <h2>Cost Optimization Recommendations</h2>
                
                <!-- Cost Savings Counter -->
                <div id="savingsCounter" class="savings-counter" hidden>
                    <div class="savings-counter-main">
                        <div class="savings-label">üí∞ Total Potential Savings</div>
                        <div class="savings-amount" id="savingsAmount">$0.00</div>
                        <div class="savings-period">per month</div>
                    </div>
                    <div class="savings-breakdown" id="savingsBreakdown"></div>
                </div>
                
                <div class="recommendations-header">
                    <div class="workspace-info" id="resourceInfo"></div>
                    <div class="header-buttons">
                        <div class="filter-container">
                            <label for="recWorkspaceFilter" class="filter-label">Filter by workspace:</label>
                            <select id="recWorkspaceFilter" class="workspace-filter" onchange="filterRecommendations()">
                                <option value="all">All Workspaces</option>
                            </select>
                        </div>
                        <button id="copyBtn" class="copy-btn" onclick="copyRecommendations()" title="Copy recommendations as plain text">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                            Copy
                        </button>
                        <button id="copyMarkdownBtn" class="copy-btn" onclick="copyRecommendationsAsMarkdown()" title="Copy as Markdown">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            Markdown
                        </button>
                    </div>
                </div>
                <div id="recommendationsContent" class="recommendations-content"></div>
                
                <!-- Checklist Tracker -->
                <div id="checklistTracker" class="checklist-tracker" hidden>
                    <h3>üìã Implementation Checklist</h3>
                    <p class="checklist-subtitle">Track your progress implementing these recommendations</p>
                    <div id="checklistProgress" class="checklist-progress">
                        <div class="progress-bar-container">
                            <div id="checklistProgressBar" class="progress-bar" style="width: 0%"></div>
                        </div>
                        <span id="checklistProgressText" class="progress-text">0 of 0 completed (0%)</span>
                    </div>
                    <div id="checklistItems" class="checklist-items"></div>
                    <button id="resetChecklistBtn" class="secondary-btn" onclick="resetChecklist()" style="margin-top: 10px;">Reset Checklist</button>
                </div>
                
                <button id="newAnalysisBtn" class="secondary-btn" onclick="newAnalysis()">Start New Analysis</button>
            </section>

            <section class="quick-tips">
                <h2>Quick Reference: Azure Monitor Cost Best Practices</h2>
                <div class="tips-grid">
                    <div class="tip-card">
                        <div class="tip-icon">üìä</div>
                        <h3>Log Analytics</h3>
                        <ul>
                            <li>Use commitment tiers for predictable workloads</li>
                            <li>Configure Basic Logs for debug tables</li>
                            <li>Set up data retention policies</li>
                            <li>Create alerts for high data collection</li>
                        </ul>
                    </div>
                    <div class="tip-card">
                        <div class="tip-icon">üñ•Ô∏è</div>
                        <h3>Virtual Machines</h3>
                        <ul>
                            <li>Migrate to Azure Monitor Agent</li>
                            <li>Filter unnecessary data at collection</li>
                            <li>Reduce performance counter frequency</li>
                            <li>Avoid duplicate data collection</li>
                        </ul>
                    </div>
                    <div class="tip-card">
                        <div class="tip-icon">üì¶</div>
                        <h3>Containers</h3>
                        <ul>
                            <li>Use Managed Prometheus for metrics</li>
                            <li>Configure Container Insights selectively</li>
                            <li>Use Basic Logs for container logs</li>
                            <li>Implement OpenCost for visibility</li>
                        </ul>
                    </div>
                    <div class="tip-card">
                        <div class="tip-icon">üîî</div>
                        <h3>Alerts</h3>
                        <ul>
                            <li>Use free alert types when possible</li>
                            <li>Minimize log search alert frequency</li>
                            <li>Reduce metric alert resource scope</li>
                            <li>Set up Azure Advisor alerts</li>
                        </ul>
                    </div>
                </div>
            </section>
        </main>

        <footer>
            <p>Based on <a href="https://learn.microsoft.com/en-us/azure/azure-monitor/fundamentals/best-practices-cost" target="_blank">Azure Monitor Cost Optimization Best Practices</a></p>
            <p class="disclaimer">This tool provides recommendations based on best practices and your actual usage. Always review changes in a non-production environment first.</p>
            <p class="disclaimer">For the best experience with automatic authentication, use the <a href="https://github.com/osalzberg/azure-monitor-cost-optimizer" target="_blank">local Node.js version</a>.</p>
        </footer>
    </div>

    <script src="app.js"></script>
</body>
</html>